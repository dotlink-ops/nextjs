name: Security Dashboard

on:
  push:
    branches: ["main"]
    paths:
      - "docs/security-audit-template.md"
      - "scripts/update_security_dashboard.py"
  schedule:
    - cron: "0 9 * * MON"  # Every Monday 09:00 UTC
  workflow_dispatch:

permissions: {}

jobs:
  update-security-dashboard:
    name: Update Security Dashboard
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for git push

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Setup Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548  # v6.1.0
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Dashboard updater has zero dependencies (stdlib only)
          echo "‚úì No external dependencies required"

      - name: Run security dashboard updater
        run: |
          python scripts/update_security_dashboard.py

      - name: Commit updated dashboard
        run: |
          git config --global user.name "nexus-core Security Bot"
          git config --global user.email "security-bot@avidelta.io"
          git add docs/security-audit-template.md

          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "‚úì No changes to dashboard metrics"
          else
            git commit -m "chore: Auto-update security dashboard [skip ci]"
            git push
            echo "‚úì Dashboard changes committed and pushed"
          fi

      - name: Generate job summary
        if: always()
        run: |
          echo "## üìä Security Dashboard Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ Dashboard update completed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Dashboard update failed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify Slack (success)
        if: success()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          if [ -z "$SLACK_WEBHOOK" ]; then
            echo "‚ö†Ô∏è  SLACK_WEBHOOK not configured, skipping notification"
            exit 0
          fi
          payload=$(cat <<EOF
          {
            "text": "‚úÖ *${GITHUB_WORKFLOW}* succeeded in \`${GITHUB_REPOSITORY}\` on branch \`${GITHUB_REF_NAME}\` (commit \`${GITHUB_SHA::7}\`)."
          }
          EOF
          )
          curl -X POST -H 'Content-type: application/json' \
            --data "$payload" \
            "$SLACK_WEBHOOK"
          echo "‚úì Success notification sent to Slack"

      - name: Notify Slack (failure)
        if: failure()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          if [ -z "$SLACK_WEBHOOK" ]; then
            echo "‚ö†Ô∏è  SLACK_WEBHOOK not configured, skipping notification"
            exit 0
          fi
          payload=$(cat <<EOF
          {
            "text": "‚ùå *${GITHUB_WORKFLOW}* failed in \`${GITHUB_REPOSITORY}\` on branch \`${GITHUB_REF_NAME}\` (commit \`${GITHUB_SHA::7}\`).\nSee details: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          }
          EOF
          )
          curl -X POST -H 'Content-type: application/json' \
            --data "$payload" \
            "$SLACK_WEBHOOK"
          echo "‚úì Failure notification sent to Slack"
