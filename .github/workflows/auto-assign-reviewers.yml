name: Auto-assign reviewers after 15 days

on:
  schedule:
    - cron: '0 0 * * *' # daily
  workflow_dispatch: {}

permissions:
  pull-requests: write

jobs:
  reassign:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Reassign stale PR reviewers
        uses: actions/github-script@v7
        with:
          script: |
            const OWNER = context.repo.owner;
            const REPO = context.repo.repo;
            const DAYS = 15;
            const TARGET_REVIEWERS = ['ChatGPT Codex Connector']; // requested reviewer(s) - usernames only

            const cutoff = new Date(Date.now() - DAYS * 24 * 60 * 60 * 1000);

            core.info(`Looking for open PRs updated before ${cutoff.toISOString()}`);

            const pulls = await github.paginate(github.rest.pulls.list, {
              owner: OWNER,
              repo: REPO,
              state: 'open',
              per_page: 100,
            });

            // Validate TARGET_REVIEWERS as existing GitHub users. If a name isn't a user,
            // skip it and warn. If you intend to use a team, provide the team slug
            // and we'll update the workflow to use `team_reviewers` instead.
            const validUsers = [];
            for (const candidate of TARGET_REVIEWERS) {
              try {
                await github.rest.users.getByUsername({ username: candidate });
                validUsers.push(candidate);
              } catch (err) {
                core.warning(`Reviewer '${candidate}' not found as a GitHub user. Skipping. If this is a team, provide the team slug.`);
              }
            }

            let changed = 0;
            for (const pr of pulls) {
              const updatedAt = new Date(pr.updated_at);
              if (updatedAt < cutoff) {
                const number = pr.number;
                const currentReviewers = (pr.requested_reviewers || []).map(r => r.login);
                const currentTeams = (pr.requested_teams || []).map(t => t.slug);

                core.info(`PR #${number} is stale (updated ${pr.updated_at}).`);

                try {
                  if (currentReviewers.length || currentTeams.length) {
                    await github.rest.pulls.removeRequestedReviewers({
                      owner: OWNER,
                      repo: REPO,
                      pull_number: number,
                      reviewers: currentReviewers,
                      team_reviewers: currentTeams,
                    });
                    core.info(`Removed requested reviewers from PR #${number}: ${currentReviewers.concat(currentTeams).join(', ')}`);
                  }

                  if (!validUsers.length) {
                    core.info(`No valid user reviewers to request for PR #${number}; skipping request.`);
                    continue;
                  }

                  await github.rest.pulls.requestReviewers({
                    owner: OWNER,
                    repo: REPO,
                    pull_number: number,
                    reviewers: validUsers,
                    team_reviewers: [],
                  });

                  core.info(`Requested review from: ${validUsers.join(', ')} on PR #${number}`);
                  changed += 1;
                } catch (err) {
                  core.warning(`Failed to update PR #${number}: ${err.message}`);
                }
              }
            }

            core.info(`Processed ${pulls.length} open PR(s), updated ${changed} PR(s).`);