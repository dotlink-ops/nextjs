name: Auto-assign reviewers after 15 days

on:
  schedule:
    - cron: '0 0 * * *' # daily
  workflow_dispatch: {}

permissions:
  pull-requests: write

jobs:
  reassign:
    runs-on: ubuntu-latest
    env:
      TARGET_REVIEWERS: ${{ vars.TARGET_REVIEWERS }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Reassign stale PR reviewers
        uses: actions/github-script@v7
        with:
          script: |
            const OWNER = context.repo.owner;
            const REPO = context.repo.repo;
            const DAYS = 15;
            // `TARGET_REVIEWERS` is read from the repository variable `TARGET_REVIEWERS`.
            // Set it in repo settings as a comma-separated list of usernames or team slugs.
            // Example: "alice,bob,team-slug"
            const raw = process.env.TARGET_REVIEWERS || '';
            const TARGET_REVIEWERS = raw.split(',').map(s => s.trim()).filter(Boolean);

            const cutoff = new Date(Date.now() - DAYS * 24 * 60 * 60 * 1000);

            core.info(`Looking for open PRs updated before ${cutoff.toISOString()}`);

            const pulls = await github.paginate(github.rest.pulls.list, {
              owner: OWNER,
              repo: REPO,
              state: 'open',
              per_page: 100,
            });

            // Validate TARGET_REVIEWERS as existing GitHub users or org teams.
            // If a candidate matches a user, add to `validUsers`.
            // If a candidate matches an org team slug, add to `validTeams`.
            const validUsers = [];
            const validTeams = [];
            for (const candidate of TARGET_REVIEWERS) {
              // Try as a user first
              try {
                await github.rest.users.getByUsername({ username: candidate });
                validUsers.push(candidate);
                continue;
              } catch (err) {
                // not a user, try as a team slug under the repo owner org
              }

              try {
                // Raw request to check org team existence: GET /orgs/{org}/teams/{team_slug}
                await github.request('GET /orgs/{org}/teams/{team_slug}', {
                  org: OWNER,
                  team_slug: candidate,
                });
                validTeams.push(candidate);
                core.info(`Reviewer '${candidate}' resolved as an org team slug.`);
              } catch (err) {
                core.warning(`Reviewer '${candidate}' not found as a GitHub user or org team slug. Skipping.`);
              }
            }

            let changed = 0;
            for (const pr of pulls) {
              const updatedAt = new Date(pr.updated_at);
              if (updatedAt < cutoff) {
                const number = pr.number;
                const currentReviewers = (pr.requested_reviewers || []).map(r => r.login);
                const currentTeams = (pr.requested_teams || []).map(t => t.slug);

                core.info(`PR #${number} is stale (updated ${pr.updated_at}).`);

                try {
                  if (currentReviewers.length || currentTeams.length) {
                    await github.rest.pulls.removeRequestedReviewers({
                      owner: OWNER,
                      repo: REPO,
                      pull_number: number,
                      reviewers: currentReviewers,
                      team_reviewers: currentTeams,
                    });
                    core.info(`Removed requested reviewers from PR #${number}: ${currentReviewers.concat(currentTeams).join(', ')}`);
                  }

                  if (!validUsers.length && !validTeams.length) {
                    core.info(`No valid reviewers (users or teams) to request for PR #${number}; skipping request.`);
                    continue;
                  }

                  await github.rest.pulls.requestReviewers({
                    owner: OWNER,
                    repo: REPO,
                    pull_number: number,
                    reviewers: validUsers,
                    team_reviewers: validTeams,
                  });

                  core.info(`Requested review from users: ${validUsers.join(', ')} and teams: ${validTeams.join(', ')} on PR #${number}`);
                  changed += 1;
                } catch (err) {
                  core.warning(`Failed to update PR #${number}: ${err.message}`);
                }
              }
            }

            core.info(`Processed ${pulls.length} open PR(s), updated ${changed} PR(s).`);