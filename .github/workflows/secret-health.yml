name: Secret Health

on:
  workflow_dispatch:  # Manual trigger
  push:
    paths:
      - ".github/workflows/**"
  schedule:
    # Add 7-minute jitter to avoid org-wide cron thundering herd
    - cron: "7 12 * * *"  # Daily at 12:07 UTC (4:07 AM PT / 7:07 AM ET)

# Default least-privilege permissions
permissions: {}

jobs:
  check-secrets:
    name: Check Secrets (${{ matrix.environment }})
    runs-on: ubuntu-latest
    permissions: {}

    # Matrix strategy for multi-environment validation
    strategy:
      fail-fast: false  # Continue checking other environments if one fails
      matrix:
        environment: [repository, staging, production]

    # Only use environment for staging/production (not repository-level)
    environment: ${{ matrix.environment != 'repository' && matrix.environment || '' }}

    env:
      # Add any others on new lines (e.g., GITHUB_APP_ID, STRIPE_SECRET, etc.)
      REQUIRED_SECRETS: |
        OPENAI_API_KEY

    steps:
      - name: Validate required secrets (masked)
        env:
          # Map each required secret here:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          # Add more secrets as needed:
          # GITHUB_APP_ID: ${{ secrets.GITHUB_APP_ID }}
          # STRIPE_SECRET: ${{ secrets.STRIPE_SECRET }}
          ENVIRONMENT: ${{ matrix.environment }}
        run: |
          echo "Checking $ENVIRONMENT secrets..."
          missing=0
          for name in $REQUIRED_SECRETS; do
            val="${!name}"
            if [ -z "$val" ] || [[ "$val" == "your-openai-api-key-here" ]]; then
              echo "::error title=Secret missing in $ENVIRONMENT::Required secret '$name' is not set or is a placeholder."
              missing=1
            else
              echo "✓ $name present in $ENVIRONMENT (value masked in logs)"
            fi
          done

          if [ $missing -eq 1 ]; then
            echo ""
            echo "::error::One or more required secrets are missing in $ENVIRONMENT."
            if [ "$ENVIRONMENT" = "repository" ]; then
              echo "Add them at: https://github.com/dotlink-ops/Avidelta/settings/secrets/actions"
            else
              echo "Add them at: https://github.com/dotlink-ops/Avidelta/settings/environments"
            fi
            exit 1
          fi

          echo ""
          echo "✅ All required secrets validated in $ENVIRONMENT"

      - name: Generate job summary
        if: always()
        env:
          ENVIRONMENT: ${{ matrix.environment }}
          JOB_STATUS: ${{ job.status }}
        run: |
          if [ "$JOB_STATUS" = "success" ]; then
            echo "### ✅ Secret Health Check Passed ($ENVIRONMENT)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All required secrets are configured correctly in **$ENVIRONMENT**." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ❌ Secret Health Check Failed ($ENVIRONMENT)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "One or more required secrets are missing or misconfigured in **$ENVIRONMENT**." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Checked secrets:**" >> $GITHUB_STEP_SUMMARY
          for name in $REQUIRED_SECRETS; do
            echo "- $name" >> $GITHUB_STEP_SUMMARY
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Last checked: $(date -u +"%Y-%m-%d %H:%M UTC")_" >> $GITHUB_STEP_SUMMARY
          echo "_Environment: $ENVIRONMENT_" >> $GITHUB_STEP_SUMMARY
          echo "_Next rotation due: $(date -u -d "+90 days" +"%Y-%m-%d") (quarterly)_" >> $GITHUB_STEP_SUMMARY

      - name: Notify Slack (failure)
        if: failure()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          ENVIRONMENT: ${{ matrix.environment }}
        run: |
          if [ -z "$SLACK_WEBHOOK" ]; then
            echo "⚠️  SLACK_WEBHOOK not configured, skipping notification"
            exit 0
          fi
          payload=$(cat <<EOF
          {
            "text": "❌ *${GITHUB_WORKFLOW}* failed in \`${GITHUB_REPOSITORY}\` for environment \`${ENVIRONMENT}\` on branch \`${GITHUB_REF_NAME}\` (commit \`${GITHUB_SHA::7}\`).\nSee details: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          }
          EOF
          )
          curl -X POST -H 'Content-type: application/json' \
            --data "$payload" \
            "$SLACK_WEBHOOK"
          echo "✓ Failure notification sent to Slack"
