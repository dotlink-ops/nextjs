name: CI - Test Secrets

on: [push, workflow_dispatch]

jobs:
  test-secrets:
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Test OPENAI_API_KEY availability
        run: |
          echo "Testing OPENAI_API_KEY..."
          if [ -z "${OPENAI_API_KEY}" ]; then
            echo "✗ OPENAI_API_KEY not available"
            echo "Please add OPENAI_API_KEY to repository secrets"
            exit 1
          else
            echo "✓ OPENAI_API_KEY loaded (masked in logs)"
            echo "  Length: ${#OPENAI_API_KEY} characters"
          fi
      
      - name: Test GITHUB_TOKEN availability
        run: |
          echo "Testing GITHUB_TOKEN..."
          if [ -z "${GITHUB_TOKEN}" ]; then
            echo "✗ GITHUB_TOKEN not available"
            exit 1
          else
            echo "✓ GITHUB_TOKEN loaded (auto-provided by GitHub)"
            echo "  Length: ${#GITHUB_TOKEN} characters"
          fi
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r scripts/requirements.txt
      
      - name: Test automation script (demo mode)
        run: |
          echo "Testing daily_v2.py in demo mode..."
          python3 scripts/daily_v2.py --demo
      
      - name: Verify output was created
        run: |
          if [ ! -f output/daily_summary.json ]; then
            echo "✗ daily_summary.json not created"
            exit 1
          fi
          echo "✓ daily_summary.json created successfully"
          
          # Show first 10 lines
          echo ""
          echo "Output preview:"
          head -10 output/daily_summary.json
      
      - name: Summary
        run: |
          echo ""
          echo "════════════════════════════════════════"
          echo "✅ All CI checks passed!"
          echo "════════════════════════════════════════"
          echo "  ✓ Secrets configured correctly"
          echo "  ✓ Python dependencies installed"
          echo "  ✓ Automation script runs successfully"
          echo "  ✓ Output generated correctly"
          echo "════════════════════════════════════════"
