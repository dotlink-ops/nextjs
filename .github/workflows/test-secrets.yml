name: CI - Test Secrets

on:
  push:
  workflow_dispatch:
    inputs:
      demo_mode:
        description: 'Run in demo mode (no external API calls)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

# Least-privilege permissions
permissions:
  contents: read

jobs:
  test-secrets:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        # Pin to commit SHA for security: actions/checkout@v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Test OPENAI_API_KEY availability
        run: |
          echo "Testing OPENAI_API_KEY..."
          if [ -z "${OPENAI_API_KEY}" ]; then
            echo "✗ OPENAI_API_KEY not available"
            echo "Please add OPENAI_API_KEY to repository secrets"
            exit 1
          else
            echo "✓ OPENAI_API_KEY loaded (masked in logs)"
            echo "  Length: ${#OPENAI_API_KEY} characters"
          fi

      - name: Test GITHUB_TOKEN availability
        run: |
          echo "Testing GITHUB_TOKEN..."
          if [ -z "${GITHUB_TOKEN}" ]; then
            echo "✗ GITHUB_TOKEN not available"
            exit 1
          else
            echo "✓ GITHUB_TOKEN loaded (auto-provided by GitHub)"
            echo "  Length: ${#GITHUB_TOKEN} characters"
          fi

      - name: Set up Python
        # Pin to commit SHA for security: actions/setup-python@v5.3.0
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r scripts/requirements.txt

      - name: Test automation script (demo or real)
        run: |
          echo "Testing daily_v2.py..."
          DEMO_INPUT="${{ github.event.inputs.demo_mode }}"
          if [ -z "${DEMO_INPUT}" ]; then
            DEMO_INPUT='true'
          fi
          if [ "${DEMO_INPUT}" = "true" ]; then
            echo "Running test in demo mode"
            python3 scripts/daily_v2.py --demo
          else
            echo "Running test in real mode"
            python3 scripts/daily_v2.py
          fi

      - name: Verify output was created and handle demo outputs
        run: |
          if [ ! -f output/daily_summary.json ]; then
            echo "✗ daily_summary.json not created"
            exit 1
          fi
          echo "✓ daily_summary.json created successfully"

          # Show first 10 lines
          echo ""
          echo "Output preview:"
          head -10 output/daily_summary.json

          DEMO_INPUT="${{ github.event.inputs.demo_mode }}"
          if [ -z "${DEMO_INPUT}" ]; then
            DEMO_INPUT='true'
          fi
          echo "${DEMO_INPUT}" > output/daily_summary.json.demo_mode

          # Normalize output demo flag
          ACTUAL=$(jq -r '.metadata.demo_mode // .demo_mode' output/daily_summary.json || echo "true")
          if [ "${ACTUAL}" = "true" ] || [ "${ACTUAL}" = "True" ]; then
            ACTUAL_NORM='true'
          else
            ACTUAL_NORM='false'
          fi

          echo "Workflow input demo_mode=${DEMO_INPUT}, output metadata.demo_mode=${ACTUAL_NORM}"
          if [ "${DEMO_INPUT}" != "${ACTUAL_NORM}" ]; then
            echo "ERROR: demo_mode mismatch between workflow input and generated output"
            exit 1
          fi

          if [ "${DEMO_INPUT}" = "true" ]; then
            mkdir -p output/backups
            TIMESTAMP=$(date -u +"%Y%m%d_%H%M%S")
            cp output/daily_summary.json output/backups/daily_summary_demo_${TIMESTAMP}.json
            echo "✓ Demo output backed up to output/backups/daily_summary_demo_${TIMESTAMP}.json"
          fi

      - name: Summary
        run: |
          echo ""
          echo "════════════════════════════════════════"
          echo "✅ All CI checks passed!"
          echo "════════════════════════════════════════"
          echo "  ✓ Secrets configured correctly"
          echo "  ✓ Python dependencies installed"
          echo "  ✓ Automation script runs successfully"
          echo "  ✓ Output generated correctly"
          echo "════════════════════════════════════════"

      - name: Notify Slack (success)
        if: success()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          if [ -z "$SLACK_WEBHOOK" ]; then
            echo "⚠️  SLACK_WEBHOOK not configured, skipping notification"
            exit 0
          fi
          payload=$(cat <<EOF
          {
            "text": "✅ *${GITHUB_WORKFLOW}* passed in \`${GITHUB_REPOSITORY}\` on branch \`${GITHUB_REF_NAME}\` (commit \`${GITHUB_SHA::7}\`)."
          }
          EOF
          )
          curl -X POST -H 'Content-type: application/json' \
            --data "$payload" \
            "$SLACK_WEBHOOK"
          echo "✓ Success notification sent to Slack"

      - name: Notify Slack (failure)
        if: failure()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          if [ -z "$SLACK_WEBHOOK" ]; then
            echo "⚠️  SLACK_WEBHOOK not configured, skipping notification"
            exit 0
          fi
          payload=$(cat <<EOF
          {
            "text": "❌ *${GITHUB_WORKFLOW}* failed in \`${GITHUB_REPOSITORY}\` on branch \`${GITHUB_REF_NAME}\` (commit \`${GITHUB_SHA::7}\`).\nSee details: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          }
          EOF
          )
          curl -X POST -H 'Content-type: application/json' \
            --data "$payload" \
            "$SLACK_WEBHOOK"
          echo "✓ Failure notification sent to Slack"
