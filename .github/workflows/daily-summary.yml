name: Daily Summary Automation

on:
  schedule:
    # Runs daily at 1:00 PM UTC (5:00 AM PT / 8:00 AM ET)
    - cron: "0 13 * * *"
  workflow_dispatch:  # Allow manual triggering

jobs:
  run-daily-and-sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r scripts/requirements.txt
      
      - name: Validate secrets (sanity check)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Validating required secrets..."
          
          if [ -z "${OPENAI_API_KEY}" ]; then
            echo "✗ OPENAI_API_KEY missing"
            echo "Add it at: https://github.com/dotlink-ops/Avidelta/settings/secrets/actions"
            exit 1
          else
            echo "✓ OPENAI_API_KEY present (value masked)"
          fi
          
          if [ -z "${GITHUB_TOKEN}" ]; then
            echo "✗ GITHUB_TOKEN missing"
            exit 1
          else
            echo "✓ GITHUB_TOKEN present (auto-provided)"
          fi
          
          echo "✓ All required secrets validated"
      
      - name: Run daily automation
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_NAME: dotlink-ops/Avidelta
        run: |
          python3 scripts/daily_v2.py
      
      - name: Verify output was created
        run: |
          if [ ! -f output/daily_summary.json ]; then
            echo "Error: daily_summary.json not created"
            exit 1
          fi
          echo "✓ daily_summary.json created successfully"
          cat output/daily_summary.json | head -20
      
      - name: Copy to public data directory
        run: |
          mkdir -p public/data
          cp output/daily_summary.json public/data/daily_summary.json
          echo "✓ Copied to public/data/"
      
      - name: Commit and push changes
        run: |
          git config user.name "automation-bot"
          git config user.email "automation-bot@users.noreply.github.com"
          git add public/data/daily_summary.json output/daily_summary.json
          
          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "No changes to commit - daily summary is unchanged"
            exit 0
          fi
          
          # Commit with timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          git commit -m "chore: update daily summary - $TIMESTAMP

          Automated daily run:
          - Generated new daily_summary.json
          - Updated public/data for API consumption
          
          Triggered by: GitHub Actions cron"
          
          git push origin main
          echo "✓ Changes pushed to main - Vercel will auto-deploy"
